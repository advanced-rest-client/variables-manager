<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../../../@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../../../@polymer/test-fixture/test-fixture.js"></script>
    <script src="../../../mocha/mocha.js"></script>
    <script src="../../../chai/chai.js"></script>
    <script src="../../../wct-mocha/wct-mocha.js"></script>

    <script src="../../../pouchdb/dist/pouchdb.js"></script>
  </head>
  <body>
    <variables-model></variables-model>
    <test-fixture id="Env">
      <template>
        <variables-manager environment="test"></variables-manager>
      </template>
    </test-fixture>

    <test-fixture id="SysDisabled">
      <template>
        <variables-manager sys-variables-disabled></variables-manager>
      </template>
    </test-fixture>

    <script type="module">
    import '../variables-manager.js';
    import '../../../@advanced-rest-client/arc-models/variables-model.js';
    import {DataGenerator} from '../../../@advanced-rest-client/arc-data-generator/arc-data-generator.js';
    import {VariablesTestHelper} from './helper.js';

    suite('System variables tests', function() {
      suite('Basic computation', () => {
        let element;
        let sysVars;
        setup(() => {
          sysVars = {
            s1: 'v1',
            s2: 'v2',
            s3: 'v3'
          };
        });

        suiteTeardown(() => DataGenerator.destroyVariablesData());

        test('Computes _sysVars', (done) => {
          element = fixture('Env');
          element.addEventListener('initialized-changed', function clb() {
            element.removeEventListener('initialized-changed', clb);
            element.systemVariables = sysVars;
            assert.typeOf(element._sysVars, 'array');
            assert.lengthOf(element._sysVars, 3);
            done();
          });
        });

        test('sysVar is set on computed items', (done) => {
          element = fixture('Env');
          element.addEventListener('initialized-changed', function clb() {
            element.removeEventListener('initialized-changed', clb);
            element.systemVariables = sysVars;
            element._sysVars.forEach((item) => {
              assert.isTrue(item.sysVar);
            });
            done();
          });
        });

        test('Sys variables applies to all environments', (done) => {
          element = fixture('Env');
          element.addEventListener('initialized-changed', function clb() {
            element.removeEventListener('initialized-changed', clb);
            element.systemVariables = sysVars;
            element._sysVars.forEach((item) => {
              assert.equal(item.environment, '*');
            });
            done();
          });
        });

        test('Does not compute variables if disabled', (done) => {
          element = fixture('SysDisabled');
          element.addEventListener('initialized-changed', function clb() {
            element.removeEventListener('initialized-changed', clb);
            element.systemVariables = sysVars;
            assert.isUndefined(element._sysVars);
            done();
          });
        });

        test('Dispaches vars change event when changing system variables', (done) => {
          element = fixture('Env');
          element.addEventListener('initialized-changed', function clb() {
            element.removeEventListener('initialized-changed', clb);
            element.addEventListener('variables-list-changed', function clb2(e) {
              element.removeEventListener('variables-list-changed', clb2);
              assert.typeOf(e.detail.value, 'array');
              assert.lengthOf(e.detail.value, 3);
              done();
            });
            element.systemVariables = sysVars;
          });
        });
      });

      suite('Combination with app variables', () => {
        let vars;
        suiteSetup(function() {
          return document.querySelector('variables-model').updateEnvironment({
            name: 'test'
          })
          .then(() => {
            vars = [{
              _id: 'a',
              variable: 'a',
              value: 'a',
              environment: 'test'
            }, {
              _id: 'b',
              variable: 'b',
              value: 'b',
              environment: 'test'
            }];
            return VariablesTestHelper.addVars(vars);
          });
        });

        suiteTeardown(() => DataGenerator.destroyVariablesData());

        let element;
        setup((done) => {
          element = fixture('Env');
          element.systemVariables = {
            s1: 'v1',
            s2: 'v2',
            s3: 'v3'
          };
          element.addEventListener('initialized-changed', function clb() {
            element.removeEventListener('initialized-changed', clb);
            done();
          });
        });

        test('Comnputes combined list of variables', () => {
          const vars = element.listAllVariables();
          assert.typeOf(vars, 'array');
          assert.lengthOf(vars, 5);
        });
      });
    });
    </script>

  </body>
</html>
