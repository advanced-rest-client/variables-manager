<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=yes">
  <title>variables-manager demo</title>
  <script src="../../webcomponentsjs/webcomponents-loader.js"></script>
  <link rel="import" href="../../polymer/lib/elements/dom-bind.html">
  <link rel="import" href="../../polymer/lib/elements/dom-if.html">
  <link rel="import" href="../../shadycss/apply-shim.html">
  <link rel="import" href="../../polymer/lib/elements/custom-style.html">
  <link rel="import" href="../../iron-demo-helpers/demo-pages-shared-styles.html">
  <link rel="import" href="../../paper-input/paper-input.html">
  <link rel="import" href="../../paper-button/paper-button.html">
  <link rel="import" href="../../iron-form/iron-form.html">
  <link rel="import" href="../../paper-dropdown-menu/paper-dropdown-menu.html">
  <link rel="import" href="../../paper-listbox/paper-listbox.html">
  <link rel="import" href="../../paper-item/paper-item.html">
  <link rel="import" href="../../neon-animation/web-animations.html">
  <link rel="import" href="../../app-pouchdb/pouchdb.html">
  <link rel="import" href="../variables-manager.html">
  <custom-style>
    <style is="custom-style" include="demo-pages-shared-styles">
    .env-name {
      margin-right: 8px;
    }

    .env-name:after {
      content: ',';
    }

    .item {
      margin: 8px 0;
    }

    .label {
      font-weight: 500;
    }
    </style>
  </custom-style>
</head>
<body unresolved>
  <dom-bind id="app">
    <template is="dom-bind">
      <div class="vertical-section-container centered">
        <h3>The `variables-manager`</h3>
        <variables-manager></variables-manager>

        <h3>Available data</h3>
        <div class="preview">
          <div class="item">
            <span class="label">Current environment:</span>
            <span class="value">[[environment]]</span>
          </div>
          <div class="item">
            <span class="label">Variables in the environment:</span>
            <span class="value">
              <template is="dom-repeat" items="[[variables]]"><span class="env-name">[[item.variable]]</span></template>
            </span>
          </div>
          <div class="item">
            <span class="label">Available environments:</span>
            <span class="value">
              <template is="dom-repeat" items="[[environments]]"><span class="env-name">[[item.name]]</span></template>
            </span>
          </div>
        </div>
        <h3>Data editor</h3>
        <div class="editor">

          <h4>Add environment</h4>
          <iron-form id="addEnv">
            <form>
              <paper-input name="name" label="Environment name"></paper-input>
              <paper-button on-tap="addEnv">Add environment</paper-button>
            </form>
          </iron-form>
          <h4>Remove environment</h4>
          <iron-form id="removeEnv">
            <form>
              <paper-dropdown-menu name="name" label="Select environment">
                <paper-listbox slot="dropdown-content" attr-for-selected="value">
                  <template is="dom-repeat" items="[[environments]]">
                    <paper-item value$="[[item.name]]">[[item.name]]</paper-item>
                  </template>
                </paper-listbox>
              </paper-dropdown-menu>
              <paper-button on-tap="removeEnv">Remove environment</paper-button>
            </form>
          </iron-form>
          <h4>Select environment</h4>
          <iron-form id="selectEnv">
            <form>
              <paper-dropdown-menu name="name" label="Select environment">
                <paper-listbox slot="dropdown-content" attr-for-selected="value">
                  <paper-item value="default">Default</paper-item>
                  <template is="dom-repeat" items="[[environments]]">
                    <paper-item value$="[[item.name]]">[[item.name]]</paper-item>
                  </template>
                </paper-listbox>
              </paper-dropdown-menu>
              <paper-button on-tap="selectEnv">Select environment</paper-button>
            </form>
          </iron-form>
          <template is="dom-if" if="[[selectedEnvironment]]">
            <h4>Edit environment [[selectedEnvironment.name]]</h4>
            <iron-form id="updateEnv">
              <form>
                <paper-input name="name" label="Environment name" value="{{selectedEnvironment.name}}"></paper-input>
                <paper-button on-tap="updateEnv">Update environment</paper-button>
              </form>
            </iron-form>
          </template>
          <h4>Add variable</h4>
          <iron-form id="addVar">
            <form>
              <input type="hidden" name="environment" value$="[[environment]]"/>
              <paper-input name="variable" label="Variable name"></paper-input>
              <paper-input name="value" label="Variable body"></paper-input>
              <paper-button on-tap="addVar">Add variable</paper-button>
            </form>
          </iron-form>
          <template is="dom-if" if="[[hasVariables]]">
            <h4>Remove variable</h4>
            <iron-form id="removeVar">
              <form>
                <paper-dropdown-menu name="variable" label="Select variable">
                  <paper-listbox slot="dropdown-content" attr-for-selected="value">
                    <template is="dom-repeat" items="[[variables]]">
                      <paper-item value$="[[item.variable]]">[[item.variable]]</paper-item>
                    </template>
                  </paper-listbox>
                </paper-dropdown-menu>
                <paper-button on-tap="removeVar">Remove variable</paper-button>
              </form>
            </iron-form>
            <h4>Select variable</h4>
            <iron-form id="selectVar">
              <form>
                <paper-dropdown-menu name="variable" label="Select variable">
                  <paper-listbox slot="dropdown-content" attr-for-selected="value">
                    <template is="dom-repeat" items="[[variables]]">
                      <paper-item value$="[[item.variable]]">[[item.variable]]</paper-item>
                    </template>
                  </paper-listbox>
                </paper-dropdown-menu>
                <paper-button on-click="selectVar">Select variable</paper-button>
              </form>
            </iron-form>
          </template>

          <template is="dom-if" if="[[selectedVariable]]">
            <h4>Edit variable</h4>
            <iron-form id="updateVar">
              <form>
                <paper-input name="variable" label="Variable name" value="{{selectedVariable.variable}}"></paper-input>
                <paper-input name="value" label="Variable body" value="{{selectedVariable.value}}"></paper-input>
                <paper-button on-tap="updateVar">Update variable</paper-button>
              </form>
            </iron-form>
          </template>
        </div>
      </div>
    </template>
  </dom-bind>
  <script>
  (function(scope) {
    function $(selector, node) {
      return (node ? node : document).querySelector(selector);
    }
    scope.environment = undefined;
    scope.variables = undefined;
    scope.environments = undefined;
    scope.selectedEnvironment = undefined;
    scope.hasVariables = false;
    scope.selectedVariable = undefined;

    window.addEventListener('selected-environment-changed', function(e) {
      const name = e.detail.value;
      scope.set('environment', name);
      if (name !== 'default') {
        const item = scope.environments.find((item) => item.name === name);
        scope.set('selectedEnvironment', undefined);
        setTimeout(() => {
          scope.set('selectedEnvironment', item);
        }, 1);
      } else {
        scope.set('selectedEnvironment', false);
      }
    });

    window.addEventListener('variables-list-changed', function(e) {
      scope.set('variables', undefined);
      scope.hasVariables = false;
      setTimeout(() => {
        scope.set('variables', e.detail.value);
        scope.hasVariables = !!(e.detail.value && e.detail.value.length);
      }, 1);
    });

    window.addEventListener('environments-list-changed', function(e) {
      scope.set('environments', undefined);
      setTimeout(() => {
        scope.set('environments', e.detail.value);
      }, 1);
    });

    scope.addEnv = function() {
      const form = $('#addEnv');
      const values = form.serializeForm();
      if (!values.name) {
        return;
      }
      scope.dispatchEvent(new CustomEvent('environment-updated', {
        cancelable: true,
        composed: true,
        bubbles: true,
        detail: {
          value: values
        }
      }));
    };

    scope.removeEnv = function() {
      if (!scope.environments) {
        return;
      }
      const form = $('#removeEnv');
      const values = form.serializeForm();
      if (!values.name) {
        return;
      }
      // find the environment for it's ID
      const item = scope.environments.find(function(item) {
        return item.name === values.name;
      });
      if (!item) {
        return;
      }
      scope.dispatchEvent(new CustomEvent('environment-deleted', {
        cancelable: true,
        composed: true,
        bubbles: true,
        detail: {
          value: item._id
        }
      }));
      if (scope.selectedEnvironment && scope.selectedEnvironment._id === item._id) {
        scope.set('selectedEnvironment', false);
      }
    };

    scope.selectEnv = function() {
      if (!scope.environments) {
        return;
      }
      const form = $('#selectEnv');
      const values = form.serializeForm();
      if (!values.name) {
        return;
      }
      scope.dispatchEvent(new CustomEvent('selected-environment-changed', {
        cancelable: true,
        composed: true,
        bubbles: true,
        detail: {
          value: values.name
        }
      }));
    };
    scope.updateEnv = function() {
      scope.dispatchEvent(new CustomEvent('environment-updated', {
        cancelable: true,
        composed: true,
        bubbles: true,
        detail: {
          value: scope.selectedEnvironment
        }
      }));
      scope.set('selectedEnvironment', false);
    };

    scope.addVar = function() {
      const form = $('#addVar');
      const values = form.serializeForm();
      if (!values.variable) {
        return;
      }
      scope.dispatchEvent(new CustomEvent('variable-updated', {
        cancelable: true,
        composed: true,
        bubbles: true,
        detail: {
          value: values
        }
      }));
    };
    scope.selectVar = function() {
      if (!scope.variables) {
        return;
      }
      const form = $('#selectVar');
      const values = form.serializeForm();
      if (!values.variable) {
        return;
      }
      const item = scope.variables.find(function(item) {
        return item.variable === values.variable;
      });
      scope.set('selectedVariable', undefined);
      setTimeout(() => {
        scope.set('selectedVariable', item);
      }, 1);
    };

    scope.updateVar = function() {
      scope.dispatchEvent(new CustomEvent('variable-updated', {
        cancelable: true,
        composed: true,
        bubbles: true,
        detail: {
          value: scope.selectedVariable
        }
      }));
      scope.set('selectedVariable', false);
    };

    scope.removeVar = function() {
      if (!scope.variables) {
        return;
      }
      const form = $('#removeVar');
      const values = form.serializeForm();
      if (!values.variable) {
        return;
      }
      // find the environment for it's ID
      const item = scope.variables.find(function(item) {
        return item.variable === values.variable;
      });
      if (!item) {
        return;
      }
      scope.dispatchEvent(new CustomEvent('variable-deleted', {
        cancelable: true,
        composed: true,
        bubbles: true,
        detail: {
          value: item._id
        }
      }));
      if (scope.selectedVariable._id === item._id) {
        scope.set('selectedVariable', false);
      }
    };
  })(document.getElementById('app'));
  </script>
</body>
</html>
